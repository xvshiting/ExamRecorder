# Webcam功能使用说明

## 概述

本项目已集成webcam功能，可以自动发现、连接和获取webcam影像。支持实时预览、拍照等功能。

## 功能特性

### 1. 自动设备发现
- 自动扫描系统中的可用摄像头设备
- 显示设备索引、分辨率和帧率信息
- 支持多个摄像头设备切换

### 2. 实时预览
- 实时显示摄像头画面
- 支持自定义分辨率设置
- 流畅的视频流显示（约30fps）

### 3. 拍照功能
- 一键拍摄快照
- 自动保存到data目录
- 时间戳命名，避免文件冲突

### 4. 🎬 视频录制功能（新增）
- **实时视频录制**: 支持录制webcam视频流
- **自定义帧率**: 可设置1-60fps的录制帧率
- **高质量输出**: 使用MP4格式，保持原始分辨率
- **录制状态显示**: 实时显示录制时长、帧数等信息
- **自动文件管理**: 录制文件自动保存到data目录

### 5. 集成到主界面
- 在主窗口中添加了webcam控制面板
- 左侧保持原有功能，右侧新增webcam功能
- 统一的界面风格

## 安装依赖

```bash
pip install -r requirements.txt
```

主要依赖包：
- `PyQt5`: GUI框架
- `opencv-python`: 摄像头和图像处理
- `mss`: 屏幕录制
- `numpy`: 数值计算

## 使用方法

### 1. 启动主程序
```bash
python main.py
```

### 2. 使用webcam功能

#### 发现设备
1. 点击"刷新"按钮扫描可用摄像头
2. 在下拉菜单中选择要使用的设备

#### 连接摄像头
1. 选择设备后点击"连接"按钮
2. 连接成功后状态会显示"已连接"

#### 开始预览
1. 连接成功后点击"开始预览"
2. 摄像头画面会实时显示在右侧预览区域

#### 拍照
1. 在预览状态下点击"拍照"按钮
2. 图片会自动保存到`data/webcam_snapshot_时间戳.jpg`

#### 🎬 视频录制（新功能）
1. **设置录制参数**:
   - 在"录制帧率"中选择合适的帧率（默认30fps）
   - 帧率越高，视频越流畅，但文件也越大

2. **开始录制**:
   - 点击"开始录制"按钮
   - 按钮会变红，表示正在录制
   - 录制状态会显示"录制中"

3. **录制过程**:
   - 实时显示录制时长和帧数
   - 可以同时进行预览和录制
   - 录制过程中可以继续使用其他功能

4. **停止录制**:
   - 点击"停止录制"按钮
   - 系统会自动保存视频文件
   - 显示录制完成信息

5. **录制文件**:
   - 视频文件保存为`data/webcam_recording_时间戳.mp4`
   - 保持摄像头原始分辨率
   - 使用MP4格式，兼容性好

#### 断开连接
1. 点击"断开"按钮停止使用摄像头
2. 预览会自动停止

## 独立测试工具

### 基础功能测试
如果只想测试webcam基础功能，可以使用：

```bash
python webcam_test.py
```

这个工具提供了更详细的webcam功能测试，包括：
- 设备信息显示
- 分辨率设置
- 详细的错误信息

### 🎬 录制功能测试（新工具）
专门用于测试视频录制功能：

```bash
python webcam_recording_test.py
```

这个工具提供了更详细的录制功能测试，包括：
- 实时录制状态显示
- 录制时长计时器
- 详细的录制日志
- 录制进度信息

## 技术实现

### WebcamManager类
- 负责摄像头设备的发现、连接和管理
- 使用OpenCV的VideoCapture进行设备操作
- 多线程处理视频流，避免界面卡顿

### WebcamDisplay类
- 自定义的QLabel组件，用于显示摄像头画面
- 自动缩放图像以适应显示区域
- 保持图像比例不变形

### 🎬 WebcamRecorder类（新增）
- **多线程录制**: 独立的录制线程，不阻塞界面
- **实时状态反馈**: 通过信号机制实时更新录制状态
- **错误处理**: 完善的录制错误处理和恢复机制
- **资源管理**: 自动管理视频写入器和文件资源

### 信号机制
- 使用PyQt5的信号槽机制进行线程间通信
- 视频帧通过信号传递给显示组件
- 录制状态通过信号实时反馈
- 错误和状态信息实时显示

## 常见问题

### 1. 无法发现摄像头
- 检查摄像头是否正确连接
- 确认摄像头没有被其他程序占用
- 尝试重新插拔摄像头

### 2. 画面卡顿
- 降低摄像头分辨率
- 关闭其他占用摄像头的程序
- 检查系统性能

### 3. 连接失败
- 确认摄像头驱动已正确安装
- 尝试使用不同的设备索引
- 重启程序或系统

## 录制功能详解

### 录制参数
- **帧率**: 1-60fps，建议30fps平衡质量和文件大小
- **分辨率**: 自动使用摄像头原始分辨率
- **格式**: MP4格式，兼容性好
- **编码**: H.264编码，压缩效率高

### 录制状态
- **未录制**: 初始状态
- **录制中**: 正在录制，按钮变红
- **录制完成**: 录制结束，显示统计信息
- **录制错误**: 出现错误，显示错误信息

### 文件管理
- 自动创建data目录
- 时间戳命名避免冲突
- 录制完成后显示文件路径
- 支持查看录制统计信息

## 扩展功能

可以基于现有代码扩展更多功能：
- 视频滤镜效果
- 人脸检测和跟踪
- 多摄像头同时录制
- 网络摄像头支持
- 录制质量设置
- 视频压缩选项

## 注意事项

1. 首次使用可能需要授予摄像头权限
2. 某些系统可能需要管理员权限
3. 建议在光线充足的环境下使用
4. 定期清理data目录中的文件
5. 🎬 录制时确保有足够的磁盘空间
6. 长时间录制建议定期检查文件大小 